import React, { useState } from 'react';
import { Download, Trash2, Plus, Copy, RotateCcw, CornerDownLeft } from 'lucide-react';

export default function PixelLetterDraft() {
  const [lines, setLines] = useState([[]]);
  const [currentLine, setCurrentLine] = useState(0);
  const [currentLetter, setCurrentLetter] = useState({
    char: '',
    grid: Array(5).fill().map(() => Array(3).fill(false))
  });

  const togglePixel = (row, col) => {
    const newGrid = currentLetter.grid.map((r, i) => 
      i === row ? r.map((c, j) => j === col ? !c : c) : r
    );
    setCurrentLetter({ ...currentLetter, grid: newGrid });
  };

  const addLetter = () => {
    if (currentLetter.char) {
      const newLines = [...lines];
      newLines[currentLine] = [...newLines[currentLine], { ...currentLetter }];
      setLines(newLines);
      setCurrentLetter({
        char: '',
        grid: Array(5).fill().map(() => Array(3).fill(false))
      });
    }
  };

  const addNewLine = () => {
    setLines([...lines, []]);
    setCurrentLine(lines.length);
  };

  const clearGrid = () => {
    setCurrentLetter({
      ...currentLetter,
      grid: Array(5).fill().map(() => Array(3).fill(false))
    });
  };

  const deleteLetter = (lineIdx, letterIdx) => {
    const newLines = lines.map((line, i) => 
      i === lineIdx ? line.filter((_, j) => j !== letterIdx) : line
    );
    setLines(newLines);
  };

  const deleteLine = (lineIdx) => {
    if (window.confirm('Delete this entire line?')) {
      const newLines = lines.filter((_, i) => i !== lineIdx);
      if (newLines.length === 0) {
        setLines([[]]);
        setCurrentLine(0);
      } else {
        setLines(newLines);
        if (currentLine >= newLines.length) {
          setCurrentLine(newLines.length - 1);
        }
      }
    }
  };

  const clearAll = () => {
    if (window.confirm('Clear everything?')) {
      setLines([[]]);
      setCurrentLine(0);
    }
  };

  const countPixels = (grid) => {
    return grid.flat().filter(cell => cell).length;
  };

  const getTotalLetters = () => {
    return lines.reduce((sum, line) => sum + line.length, 0);
  };

  const getTotalPixels = () => {
    return lines.reduce((sum, line) => 
      sum + line.reduce((lineSum, letter) => lineSum + countPixels(letter.grid), 0), 0);
  };

  const getLineWidth = (line) => {
    if (line.length === 0) return 0;
    return line.length * 3 + (line.length - 1);
  };

  const getMaxWidth = () => {
    return Math.max(...lines.map(line => getLineWidth(line)), 0);
  };

  const getTotalHeight = () => {
    const nonEmptyLines = lines.filter(line => line.length > 0).length;
    if (nonEmptyLines === 0) return 0;
    return nonEmptyLines * 5 + (nonEmptyLines - 1);
  };

  const exportDesign = () => {
    let text = '=== PIXEL LETTER DESIGN ===\n\n';
    text += `Total Lines: ${lines.filter(l => l.length > 0).length}\n`;
    text += `Total Letters: ${getTotalLetters()}\n`;
    text += `Total Pixels: ${getTotalPixels()}\n`;
    text += `Max Width: ${getMaxWidth()} blocks\n`;
    text += `Total Height: ${getTotalHeight()} blocks\n\n`;
    
    lines.forEach((line, lineIdx) => {
      if (line.length > 0) {
        text += `--- Line ${lineIdx + 1} ---\n`;
        text += `Text: ${line.map(l => l.char).join('')}\n`;
        text += `Width: ${getLineWidth(line)} blocks\n\n`;
        
        line.forEach((letter, letterIdx) => {
          text += `${letter.char} (${countPixels(letter.grid)} pixels):\n`;
          text += letter.grid.map(row => row.map(cell => cell ? '█' : '·').join('')).join('\n');
          text += '\n\n';
        });
      }
    });
    
    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'pixel-letters.txt';
    a.click();
  };

  const copyToClipboard = () => {
    const text = lines.map(line => line.map(l => l.char).join('')).filter(l => l).join('\n');
    navigator.clipboard.writeText(text);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 p-4 md:p-8">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="text-center mb-8">
          <h1 className="text-5xl md:text-6xl font-black text-white mb-3 tracking-tight">
            PIXEL LETTER STUDIO
          </h1>
          <p className="text-xl text-purple-200">Design 3×5 Pixel Art Letters</p>
        </div>

        {/* Stats Bar */}
        {getTotalLetters() > 0 && (
          <div className="bg-white/10 backdrop-blur-md rounded-xl p-4 mb-6 border border-white/20">
            <div className="grid grid-cols-2 md:grid-cols-5 gap-4 text-center">
              <div>
                <div className="text-3xl font-bold text-white">{lines.filter(l => l.length > 0).length}</div>
                <div className="text-sm text-purple-200">Lines</div>
              </div>
              <div>
                <div className="text-3xl font-bold text-white">{getTotalLetters()}</div>
                <div className="text-sm text-purple-200">Letters</div>
              </div>
              <div>
                <div className="text-3xl font-bold text-white">{getTotalPixels()}</div>
                <div className="text-sm text-purple-200">Total Blocks</div>
              </div>
              <div>
                <div className="text-3xl font-bold text-white">{getMaxWidth()}</div>
                <div className="text-sm text-purple-200">Max Width</div>
              </div>
              <div>
                <div className="text-3xl font-bold text-white">{getTotalHeight()}</div>
                <div className="text-sm text-purple-200">Total Height</div>
              </div>
            </div>
          </div>
        )}

        <div className="grid lg:grid-cols-2 gap-6">
          {/* Editor */}
          <div className="bg-white/10 backdrop-blur-md rounded-2xl p-6 shadow-2xl border border-white/20">
            <h2 className="text-2xl font-bold text-white mb-4 flex items-center gap-2">
              <span className="bg-gradient-to-r from-yellow-400 to-orange-500 w-2 h-8 rounded"></span>
              Design Letter
            </h2>

            {/* Line Selector */}
            <div className="mb-4">
              <div className="flex items-center gap-2 mb-2">
                <label className="text-purple-200 text-sm font-semibold">Current Line:</label>
                <select 
                  value={currentLine}
                  onChange={(e) => setCurrentLine(Number(e.target.value))}
                  className="bg-white/10 border-2 border-white/20 text-white rounded-lg px-3 py-1 focus:outline-none focus:border-yellow-400"
                >
                  {lines.map((_, idx) => (
                    <option key={idx} value={idx} className="bg-purple-900">
                      Line {idx + 1} ({lines[idx].length} letters)
                    </option>
                  ))}
                </select>
                <button
                  onClick={addNewLine}
                  className="bg-gradient-to-r from-blue-500 to-cyan-600 hover:from-blue-600 hover:to-cyan-700 text-white px-4 py-2 rounded-lg font-semibold flex items-center gap-2 shadow-lg transition-all transform hover:scale-105"
                >
                  <CornerDownLeft size={16} />
                  New Line
                </button>
              </div>
            </div>
            
            <input
              type="text"
              maxLength="1"
              value={currentLetter.char}
              onChange={(e) => setCurrentLetter({ ...currentLetter, char: e.target.value.toUpperCase() })}
              placeholder="Enter letter..."
              className="w-full mb-6 px-6 py-4 bg-white/10 border-2 border-white/20 text-white rounded-xl text-center text-3xl font-bold placeholder-white/40 focus:outline-none focus:border-yellow-400 transition-all"
            />

            <div className="flex justify-center mb-6">
              <div className="inline-block bg-black/30 p-6 rounded-2xl border-2 border-white/20">
                {currentLetter.grid.map((row, i) => (
                  <div key={i} className="flex gap-2 mb-2 last:mb-0">
                    {row.map((cell, j) => (
                      <button
                        key={j}
                        onClick={() => togglePixel(i, j)}
                        className={`w-16 h-16 rounded-lg transition-all transform hover:scale-105 active:scale-95 ${
                          cell 
                            ? 'bg-gradient-to-br from-yellow-400 to-orange-500 shadow-lg shadow-orange-500/50' 
                            : 'bg-white/10 hover:bg-white/20 border-2 border-white/20'
                        }`}
                      />
                    ))}
                  </div>
                ))}
              </div>
            </div>

            {/* Pixel Count for Current Letter */}
            <div className="text-center mb-4 text-purple-200 text-sm">
              Current: {countPixels(currentLetter.grid)} blocks filled
            </div>

            <div className="flex gap-3">
              <button
                onClick={addLetter}
                disabled={!currentLetter.char}
                className="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 disabled:from-gray-600 disabled:to-gray-700 text-white px-6 py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2 shadow-lg transition-all transform hover:scale-105 active:scale-95 disabled:scale-100"
              >
                <Plus size={24} />
                Add to Line {currentLine + 1}
              </button>
              <button
                onClick={clearGrid}
                className="bg-white/10 hover:bg-white/20 border-2 border-white/20 text-white px-6 py-4 rounded-xl flex items-center gap-2 transition-all transform hover:scale-105 active:scale-95"
              >
                <RotateCcw size={20} />
              </button>
            </div>
          </div>

          {/* Letter List */}
          <div className="bg-white/10 backdrop-blur-md rounded-2xl p-6 shadow-2xl border border-white/20">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-2xl font-bold text-white flex items-center gap-2">
                <span className="bg-gradient-to-r from-blue-400 to-cyan-500 w-2 h-8 rounded"></span>
                Your Lines
              </h2>
              <div className="flex gap-2">
                {getTotalLetters() > 0 && (
                  <>
                    <button
                      onClick={copyToClipboard}
                      className="bg-white/10 hover:bg-white/20 text-white px-3 py-2 rounded-lg text-sm flex items-center gap-2 border border-white/20 transition-all"
                      title="Copy text"
                    >
                      <Copy size={16} />
                    </button>
                    <button
                      onClick={exportDesign}
                      className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2 shadow-lg transition-all transform hover:scale-105"
                    >
                      <Download size={16} />
                      Export
                    </button>
                    <button
                      onClick={clearAll}
                      className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2 shadow-lg transition-all transform hover:scale-105"
                    >
                      <Trash2 size={16} />
                    </button>
                  </>
                )}
              </div>
            </div>

            <div className="space-y-4 max-h-[500px] overflow-y-auto pr-2 custom-scrollbar">
              {getTotalLetters() === 0 ? (
                <div className="text-center py-16">
                  <div className="text-6xl mb-4">✨</div>
                  <p className="text-purple-200 text-lg">No letters yet</p>
                  <p className="text-purple-300/60 text-sm mt-2">Start designing your first letter!</p>
                </div>
              ) : (
                lines.map((line, lineIdx) => (
                  line.length > 0 && (
                    <div key={lineIdx} className="bg-white/5 rounded-xl p-4 border border-white/10">
                      <div className="flex justify-between items-center mb-3">
                        <div className="flex items-center gap-3">
                          <span className="text-purple-200 font-bold">Line {lineIdx + 1}</span>
                          <span className="text-purple-300/60 text-sm">
                            {line.length} letters · {getLineWidth(line)} blocks wide
                          </span>
                        </div>
                        <button
                          onClick={() => deleteLine(lineIdx)}
                          className="text-red-400 hover:text-red-300 p-1 text-sm"
                        >
                          <Trash2 size={16} />
                        </button>
                      </div>
                      <div className="space-y-2">
                        {line.map((letter, letterIdx) => (
                          <div key={letterIdx} className="bg-white/10 backdrop-blur-sm rounded-xl p-3 flex items-center justify-between border border-white/20 hover:bg-white/20 transition-all group">
                            <div className="flex items-center gap-3">
                              <div className="text-2xl font-black text-white bg-gradient-to-br from-purple-500 to-pink-500 w-12 h-12 flex items-center justify-center rounded-lg shadow-lg">
                                {letter.char}
                              </div>
                              <div className="bg-black/30 p-2 rounded-lg border border-white/20">
                                {letter.grid.map((row, i) => (
                                  <div key={i} className="flex gap-0.5">
                                    {row.map((cell, j) => (
                                      <div
                                        key={j}
                                        className={`w-3 h-3 rounded-sm ${cell ? 'bg-gradient-to-br from-yellow-400 to-orange-500' : 'bg-white/10'}`}
                                      />
                                    ))}
                                  </div>
                                ))}
                              </div>
                              <div className="text-purple-200 text-sm">
                                {countPixels(letter.grid)} blocks
                              </div>
                            </div>
                            <button
                              onClick={() => deleteLetter(lineIdx, letterIdx)}
                              className="text-red-400 hover:text-red-300 p-2 opacity-0 group-hover:opacity-100 transition-all"
                            >
                              <Trash2 size={18} />
                            </button>
                          </div>
                        ))}
                      </div>
                    </div>
                  )
                ))
              )}
            </div>
          </div>
        </div>

        {/* Full Preview */}
        {getTotalLetters() > 0 && (
          <div className="mt-6 bg-white/10 backdrop-blur-md rounded-2xl p-6 shadow-2xl border border-white/20">
            <h2 className="text-2xl font-bold text-white mb-4 text-center flex items-center justify-center gap-2">
              <span className="bg-gradient-to-r from-pink-400 to-purple-500 w-2 h-8 rounded"></span>
              Full Preview
              <span className="bg-gradient-to-r from-pink-400 to-purple-500 w-2 h-8 rounded"></span>
            </h2>
            <div className="bg-black/40 p-8 rounded-xl overflow-auto border-2 border-white/20 max-h-[600px]">
              <div className="space-y-2 flex flex-col items-center">
                {lines.map((line, lineIdx) => (
                  line.length > 0 && (
                    <div key={lineIdx} className="flex gap-2 flex-shrink-0">
                      {line.map((letter, letterIdx) => (
                        <React.Fragment key={letterIdx}>
                          <div className="inline-block flex-shrink-0">
                            {letter.grid.map((row, i) => (
                              <div key={i} className="flex">
                                {row.map((cell, j) => (
                                  <div
                                    key={j}
                                    className={`w-6 h-6 flex-shrink-0 ${cell ? 'bg-white shadow-lg shadow-white/50' : 'bg-transparent'}`}
                                  />
                                ))}
                              </div>
                            ))}
                          </div>
                          {letterIdx < line.length - 1 && (
                            <div className="w-6 flex-shrink-0"></div>
                          )}
                        </React.Fragment>
                      ))}
                    </div>
                  )
                ))}
              </div>
            </div>
          </div>
        )}
      </div>

      <style jsx>{`
        .custom-scrollbar::-webkit-scrollbar {
          width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
          background: rgba(255, 255, 255, 0.05);
          border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
          background: rgba(255, 255, 255, 0.2);
          border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
          background: rgba(255, 255, 255, 0.3);
        }
      `}</style>
    </div>
  );
}
